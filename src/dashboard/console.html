<html>
    <head>
        <title>Console</title>
        <script src="js/lib/jquery.min.js"></script>
        <script src="js/lib/smoothie.js"></script>
        <script src="js/lib/dat.gui.min.js"></script>
        <script src="js/lib/modernizr-2.0.6-development-only.js"></script>
        <script type="text/javascript">
            $(function() {
                var startStreaming = function(url, onData) {
                    var xhr = new XMLHttpRequest();
                    if (xhr) {
                        if (typeof xhr.multipart == 'undefined') {
                            alert("Streaming not supported - try Firefox.");
                            return;
                        }

                        xhr.multipart = true;
                        xhr.open("GET", url, true);
                        xhr.onload = onData;
                        xhr.send(null);
                    }
                }
      
                var setStreamingVariables = function(variables) {
                    var params = {};
                    for (var i = 0; i < variables.length; ++i) {
                        params[variables[i]] = true;
                    }
                    //$.getJSON("http://10.13.10.2:8080/stream/add", {data: params});
                    $.ajax({url: "http://10.13.10.2:8080/stream/add", data: params, dataType: "json"});
                }
      
                var gui;
                var guiVariables = {};
                var addToGUI = function(obj, prop) {
                    var controller = gui.add(obj, prop);
                    guiVariables[prop] = obj[prop];
                    controller.onFinishChange(function(value) {
                        var params = {};
                        params[prop] = value;
                        $.ajax({url: "http://10.13.10.2:8080/constants", data: params, dataType: "json"})
                    });
                };
                
                var clearVariableList = function() {
                    guiVariables = {};
                }
                
                var updateVariableList = function() {
                    $.ajax({url: "http://10.13.10.2:8080/constants", dataType: "json"}).done(function(data) {
                        for(var property in data) {
                            addToGUI(data, property);
                        }
                    });
                }

                var makeSmoothieChart = function(parent, options) {
                    var newDiv = $("<div><p>" + options.title + "</p><canvas width='"
                        + options.width + "' height='" + options.height + "'/></div>");
                    $(parent).append(newDiv);
                    var chart = new SmoothieChart();
                    chart.streamTo(newDiv.children("canvas").get(0), /* delay */ 1000);
                    var series = {};
                    var l = options.dataFields.length;
                    for (var i = 0; i < l; i++) {
                        series[options.dataFields[i]] = new TimeSeries();
                        chart.addTimeSeries(series[options.dataFields[i]], { strokeStyle:'rgb(0, 255, 0)', fillStyle:'rgba(0, 0, 0, 0)' });
                    }
                    return function(now, data) {
                        var l = options.dataFields.length;
                        for (var i = 0; i < l; i++) {
                            var f = options.dataFields[i];
                            if (series.hasOwnProperty(f)) {
                                series[f].append(now, data[f]);
                            }
                        }
                    }
                }
      
                var drawRobot = function(x, y, angle) {
                    var canvas = $("#fieldCanvas")[0];
                    var context = canvas.getContext('2d');

                    context.save();
                    context.setTransform(1, 0, 0, 1, 0, 0);
                    context.clearRect(0, 0, canvas.width, canvas.height);
                    context.restore();

                    var width = 31;
                    var height = 28;

                    context.setTransform(1, 0, 0, 1, x, y);
                    context.rotate(angle * Math.PI / 180);
                    context.translate(-width / 2, -height / 2);
                    context.fillRect(0, 0, width, height);
                }
                
                
                var drawFrisbee = function(x, y, filled) {
                    var radius = 30;
                    var width = 200;
                    
                    var context = $("#frisbeeCounter")[0].getContext('2d');
                    
                    y += 1;
                    x += 1;
                    
                    context.beginPath();
                    context.moveTo(x + width / 2,y);
                    context.arcTo(x+width,y,x+width,y+radius,radius);
                    context.lineTo(x, y+radius);
                    context.arcTo(x, y, x+radius, y, radius);
                    context.closePath();

                    if(filled) {
                        context.fillStyle = "rgb(214, 255, 142)";
                    } else {
                        context.fillStyle = "white";
                    }
                    context.fill();

                    context.stroke();
                };
                
                var drawFrisbeeCounter = function(frisbeeInfo){
                    //frisbeeInfo will be a 4 digit integer, 1111 being all 4 full, 0000 being all empty
                    
                    var canvas = $("#frisbeeCounter")[0];
                    var context = canvas.getContext('2d');
                    
                    context.save();
                    context.clearRect(0, 0, canvas.width, canvas.radius);
                    context.restore();
                    
                    var stringValue = frisbeeInfo.toString();
                    
                    var length = stringValue.length;
                    var y = 40 * (4 - stringValue.length);
                    
                    for(var i = 0; i < (4 - length); ++i) {
                        drawFrisbee(0, 40 * i, false);
                    }
                    
                    for (var i = length; i > 0; --i) {
                        drawFrisbee(0, y + 40 * (i - 1), stringValue[i - 1] == '1');
                    }
                };
                setInterval(function() {
                    var str = Math.round(Math.random()) + "" + Math.round(Math.random()) + "" + Math.round(Math.random()) + "" + Math.round(Math.random());
                    
                    drawFrisbeeCounter(str);
                }, 500);

                var cameraCharts = [
                    makeSmoothieChart("#camera_charts", {
                        title: "Camera Processing Time (seconds/sec)",
                        dataFields: ["total_time"],
                        width: 200, height: 50
                    }),
                    makeSmoothieChart("#camera_charts", {
                        title: "Camera FPS",
                        dataFields: ["fps"],
                        width: 200, height: 50
                    }),
                    makeSmoothieChart("#camera_charts", {
                        title: "Camera Bandwidth (KB/sec)",
                        dataFields: ["bandwidth"],
                        width: 200, height: 50
                    }),
                ];

                var dataCharts = [
                    makeSmoothieChart("#data_charts", {
                        title: "Shooter Encoder",
                        dataFields: ["shooterEncoder"],
                        width: 400, height: 50
                    }),
                    /*makeSmoothieChart("#data_charts", {
                        title: "Data Charts Example Two",
                        dataFields: ["two", "three"],
                        width: 200, height: 50
                    }),*/
                ];
      
                var lastData = {
                    camera: new Date().getTime(),
                    data: new Date().getTime()
                };
      
                var connected = false;
                var sentInit = false;
      
                setInterval(function() {
                    var now = new Date().getTime();
                    if (now - lastData.data > 2000) {
                        //We've timed out, meaning we're current disconnected and we haven't sent our init
                        connected = false;
                        sentInit = false;
                        
                        if(gui) {
                            gui.destroy();
                            clearVariableList();
                        }
                        
                        gui = new dat.GUI( {width: 500} );
                        
                        // Robot data stream
                        startStreaming("http://10.13.10.2:8080/stream?frequency=30", function(event) {
                            //Successful connection
                            connected = true;
                            
                            lastData.data = new Date().getTime();
            
                            var data = JSON.parse(event.target.responseText);
                            var now = new Date().getTime();
                            
                            if(data.hasOwnProperty("xPosition") && data.hasOwnProperty("yPosition") && data.hasOwnProperty("anglePosition")) {
                                var x = data.xPosition;
                                var y = data.yPosition;
                                var angle = data.anglePosition;
            
                                drawRobot(x, y, angle);
                            }
                            
                            if(data.hasOwnProperty("shooterEncoder")) {
                                dataCharts[0](now, data);
                            }
                        });
                    }
                    
                    //As soon as we connect and we havent sent our init, send the init
                    if(connected && !sentInit) {
                        updateVariableList();
          
                        setStreamingVariables(["xPosition", "yPosition", "anglePosition", "shooterEncoder"]);

                        sentInit = true;
                    }
        
                    if (false && now - lastData.camera > 2000) {
                        // Camera smoothie charts
                        startStreaming("/stream/data", function(event) {
                            var data = JSON.parse(event.target.responseText);
                            var now = new Date().getTime();
                            lastData.camera = now;
                            var l = cameraCharts.length;
                            for (var i = 0; i < l; i++) {
                                cameraCharts[i](now, data);
                            }
                        });
          
                        // Start the video streams
                        $("#streams").children().remove();
                        $("#streams").append("<img src='/stream/raw?" + now + "'/>");
                        $("#streams").append("<img src='/stream/processed?" + now + "'/>");
                    }
                }, 1000);
            });
        </script>
        <style type="text/css">
            .field { position: absolute; left: 600px; right: 0px; bottom: 0px; top: 0px }
            #frisbeeCounter {position: absolute; left: 375px; right: 0px; bottom: 0px; top: 5px }
        </style>
    </head>
    <body>
        <img class="field" src="field.png"/>
        <canvas class="field" id="fieldCanvas" width="324" height="648"></canvas>
        <canvas id="frisbeeCounter" width="250" height="200"></canvas>
        <div id="output"></div>
        <div id="streams"></div>
        <div id="camera_charts"></div>
        <div id="data_charts"></div>
    </body>
</html>
